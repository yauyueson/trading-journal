# Trading Journal - æ•°æ®åº“è®¾è®¡

> æœ€åæ›´æ–°: 2026å¹´2æœˆ6æ—¥

## ğŸ“‹ ç›®å½•

1. [æ•°æ®åº“æ¦‚è¿°](#æ•°æ®åº“æ¦‚è¿°)
2. [è¡¨ç»“æ„è®¾è®¡](#è¡¨ç»“æ„è®¾è®¡)
3. [å…³ç³»è®¾è®¡](#å…³ç³»è®¾è®¡)
4. [ç´¢å¼•ç­–ç•¥](#ç´¢å¼•ç­–ç•¥)
5. [å®‰å…¨ç­–ç•¥](#å®‰å…¨ç­–ç•¥)
6. [è¿ç§»å†å²](#è¿ç§»å†å²)

---

## ğŸ—„ï¸ æ•°æ®åº“æ¦‚è¿°

### Supabase PostgreSQL

**é¡¹ç›®ä¿¡æ¯**:
- **URL**: https://irejefxhgetulqmxponl.supabase.co
- **Region**: US East (Ohio)
- **PostgreSQLç‰ˆæœ¬**: 15.x
- **å­˜å‚¨**: 500MB (å…è´¹tier)

**ç‰¹æ€§**:
- âœ… ACIDäº‹åŠ¡ä¿è¯
- âœ… Row Level Security (RLS)
- âœ… å®æ—¶è®¢é˜…ï¼ˆWebSocketï¼‰
- âœ… è‡ªåŠ¨REST APIç”Ÿæˆ
- âœ… è‡ªåŠ¨å¤‡ä»½

---

## ğŸ“Š è¡¨ç»“æ„è®¾è®¡

### 1. positions (æŒä»“è¡¨)

**ç”¨é€”**: å­˜å‚¨æ‰€æœ‰æœŸæƒæŒä»“ï¼ˆè§‚å¯Ÿåˆ—è¡¨ã€æ´»è·ƒæŒä»“ã€å†å²æŒä»“ï¼‰

**Schema**:
```sql
CREATE TABLE positions (
    -- ä¸»é”®
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    
    -- æœŸæƒåŸºæœ¬ä¿¡æ¯
    ticker VARCHAR(20) NOT NULL,           -- è‚¡ç¥¨ä»£ç  e.g. "QQQ"
    strike DECIMAL(10,2) NOT NULL,         -- è¡Œæƒä»· e.g. 630.00
    type VARCHAR(10) NOT NULL,             -- "Call" æˆ– "Put"
    expiration DATE NOT NULL,              -- åˆ°æœŸæ—¥ e.g. 2026-02-20
    
    -- çŠ¶æ€ç®¡ç†
    status VARCHAR(20) NOT NULL DEFAULT 'watchlist',  
        -- 'watchlist': è§‚å¯Ÿåˆ—è¡¨
        -- 'active': æ´»è·ƒæŒä»“
        -- 'closed': å·²å¹³ä»“
    
    -- äº¤æ˜“è®¡åˆ’
    setup VARCHAR(50),                     -- äº¤æ˜“è®¾ç½®ç±»å‹ e.g. "MB Bounce"
    entry_score INTEGER,                   -- å…¥åœºæ—¶Scanner Score (0-100)
    current_score INTEGER,                 -- å½“å‰Scanner Score (0-100)
    score_updated_at TIMESTAMPTZ,          -- Scoreæœ€åæ›´æ–°æ—¶é—´
    ideal_entry DECIMAL(10,2),             -- ç†æƒ³å…¥åœºä»· e.g. 7.50
    
    -- ä»·æ ¼å’Œé£æ§
    current_price DECIMAL(10,2),           -- å½“å‰æœŸæƒä»·æ ¼
    stop_reason TEXT,                      -- æŠ€æœ¯æ­¢æŸæ¡ä»¶ e.g. "MB flips red"
    target_price DECIMAL(10,2),            -- ç›®æ ‡ä»· e.g. 12.00
    
    -- å¤‡æ³¨å’Œæ—¶é—´æˆ³
    notes TEXT,                            -- äº¤æ˜“ç¬”è®°
    created_at TIMESTAMPTZ DEFAULT NOW(),  -- åˆ›å»ºæ—¶é—´
    closed_at TIMESTAMPTZ,                 -- å¹³ä»“æ—¶é—´
    
    -- çº¦æŸ
    CHECK (type IN ('Call', 'Put')),
    CHECK (status IN ('watchlist', 'active', 'closed')),
    CHECK (strike > 0),
    CHECK (entry_score IS NULL OR (entry_score >= 0 AND entry_score <= 100)),
    CHECK (current_score IS NULL OR (current_score >= 0 AND current_score <= 100))
);
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| id | UUID | âœ… | ä¸»é”®ï¼Œè‡ªåŠ¨ç”Ÿæˆ |
| ticker | VARCHAR(20) | âœ… | è‚¡ç¥¨ä»£ç ï¼Œå¤§å†™ |
| strike | DECIMAL(10,2) | âœ… | è¡Œæƒä»·ï¼Œç²¾ç¡®åˆ°åˆ† |
| type | VARCHAR(10) | âœ… | Callæˆ–Put |
| expiration | DATE | âœ… | åˆ°æœŸæ—¥ |
| status | VARCHAR(20) | âœ… | æŒä»“çŠ¶æ€ |
| setup | VARCHAR(50) | âŒ | äº¤æ˜“è®¾ç½®ç±»å‹ |
| entry_score | INTEGER | âŒ | å…¥åœºè¯„åˆ† |
| current_score | INTEGER | âŒ | å½“å‰è¯„åˆ† |
| score_updated_at | TIMESTAMPTZ | âŒ | è¯„åˆ†æ›´æ–°æ—¶é—´ |
| ideal_entry | DECIMAL(10,2) | âŒ | ç†æƒ³å…¥åœºä»· |
| current_price | DECIMAL(10,2) | âŒ | å½“å‰ä»·æ ¼ |
| stop_reason | TEXT | âŒ | æ­¢æŸæ¡ä»¶ |
| target_price | DECIMAL(10,2) | âŒ | ç›®æ ‡ä»· |
| notes | TEXT | âŒ | å¤‡æ³¨ |
| created_at | TIMESTAMPTZ | âœ… | åˆ›å»ºæ—¶é—´ï¼ˆè‡ªåŠ¨ï¼‰ |
| closed_at | TIMESTAMPTZ | âŒ | å¹³ä»“æ—¶é—´ |

**ç¤ºä¾‹æ•°æ®**:
```sql
INSERT INTO positions (ticker, strike, type, expiration, status, setup, entry_score, ideal_entry, stop_reason)
VALUES 
  ('QQQ', 630.00, 'Call', '2026-02-20', 'watchlist', 'MB Bounce', 85, 7.50, 'MB flips red'),
  ('SPY', 580.00, 'Put', '2026-03-15', 'active', 'Breakdown', 72, 5.20, 'Breaks above 585');
```

---

### 2. transactions (äº¤æ˜“è®°å½•è¡¨)

**ç”¨é€”**: è®°å½•æ‰€æœ‰ä¹°å…¥/å–å‡ºæ“ä½œ

**Schema**:
```sql
CREATE TABLE transactions (
    -- ä¸»é”®
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    
    -- å¤–é”®å…³è”
    position_id UUID REFERENCES positions(id) ON DELETE CASCADE,
    
    -- äº¤æ˜“ä¿¡æ¯
    type VARCHAR(20) NOT NULL,             -- äº¤æ˜“ç±»å‹
        -- 'Open': å¼€ä»“
        -- 'Size Up': åŠ ä»“
        -- 'Size Down': å‡ä»“
        -- 'Take Profit': éƒ¨åˆ†æ­¢ç›ˆ
        -- 'Close': å¹³ä»“
    
    quantity INTEGER NOT NULL,             -- æ•°é‡ï¼ˆæ­£=ä¹°å…¥ï¼Œè´Ÿ=å–å‡ºï¼‰
    price DECIMAL(10,2) NOT NULL,          -- æˆäº¤ä»·
    date TIMESTAMPTZ DEFAULT NOW(),        -- äº¤æ˜“æ—¶é—´
    note TEXT,                             -- äº¤æ˜“å¤‡æ³¨
    
    -- çº¦æŸ
    CHECK (type IN ('Open', 'Size Up', 'Size Down', 'Take Profit', 'Close')),
    CHECK (quantity != 0),
    CHECK (price > 0)
);
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| id | UUID | âœ… | ä¸»é”®ï¼Œè‡ªåŠ¨ç”Ÿæˆ |
| position_id | UUID | âœ… | å…³è”çš„æŒä»“ID |
| type | VARCHAR(20) | âœ… | äº¤æ˜“ç±»å‹ |
| quantity | INTEGER | âœ… | åˆçº¦æ•°é‡ |
| price | DECIMAL(10,2) | âœ… | æˆäº¤ä»·æ ¼ |
| date | TIMESTAMPTZ | âœ… | äº¤æ˜“æ—¶é—´ï¼ˆè‡ªåŠ¨ï¼‰ |
| note | TEXT | âŒ | äº¤æ˜“å¤‡æ³¨ |

**æ•°é‡è§„åˆ™**:
- **æ­£æ•°**: ä¹°å…¥æ“ä½œ
  - `Open`: +5 (å¼€ä»“5ä»½)
  - `Size Up`: +3 (åŠ ä»“3ä»½)
- **è´Ÿæ•°**: å–å‡ºæ“ä½œ
  - `Size Down`: -2 (å‡ä»“2ä»½)
  - `Take Profit`: -3 (æ­¢ç›ˆ3ä»½)
  - `Close`: -5 (å¹³ä»“5ä»½)

**ç¤ºä¾‹æ•°æ®**:
```sql
-- å¼€ä»“5ä»½ @ $7.50
INSERT INTO transactions (position_id, type, quantity, price, note)
VALUES ('uuid-123', 'Open', 5, 7.50, 'Entry at ideal price');

-- åŠ ä»“3ä»½ @ $6.80
INSERT INTO transactions (position_id, type, quantity, price, note)
VALUES ('uuid-123', 'Size Up', 3, 6.80, 'Dip buy');

-- æ­¢ç›ˆ4ä»½ @ $10.20
INSERT INTO transactions (position_id, type, quantity, price, note)
VALUES ('uuid-123', 'Take Profit', -4, 10.20, 'Hit target');

-- å¹³ä»“å‰©ä½™4ä»½ @ $9.50
INSERT INTO transactions (position_id, type, quantity, price, note)
VALUES ('uuid-123', 'Close', -4, 9.50, 'Close remaining');
```

---

### 3. position_greeks_history (Greekså†å²è¡¨)

**ç”¨é€”**: å­˜å‚¨IVå’ŒDeltaçš„å†å²å¿«ç…§ï¼Œç”¨äºå›¾è¡¨å±•ç¤º

**Schema**:
```sql
CREATE TABLE position_greeks_history (
    -- ä¸»é”®
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    
    -- å¤–é”®å…³è”
    position_id UUID REFERENCES positions(id) ON DELETE CASCADE,
    
    -- Greeksæ•°æ®
    iv DECIMAL(6,4) NOT NULL,              -- éšå«æ³¢åŠ¨ç‡ e.g. 0.1778
    delta DECIMAL(6,4) NOT NULL,           -- Deltaå€¼ e.g. 0.3999
    
    -- æ—¶é—´æˆ³
    recorded_at TIMESTAMPTZ DEFAULT NOW(), -- è®°å½•æ—¶é—´
    
    -- çº¦æŸ
    CHECK (iv >= 0 AND iv <= 5),           -- IVèŒƒå›´ 0-500%
    CHECK (delta >= -1 AND delta <= 1)     -- DeltaèŒƒå›´ -1åˆ°1
);
```

**å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| id | UUID | âœ… | ä¸»é”®ï¼Œè‡ªåŠ¨ç”Ÿæˆ |
| position_id | UUID | âœ… | å…³è”çš„æŒä»“ID |
| iv | DECIMAL(6,4) | âœ… | éšå«æ³¢åŠ¨ç‡ |
| delta | DECIMAL(6,4) | âœ… | Deltaå€¼ |
| recorded_at | TIMESTAMPTZ | âœ… | è®°å½•æ—¶é—´ï¼ˆè‡ªåŠ¨ï¼‰ |

**è®°å½•é¢‘ç‡**: æ¯2å°æ—¶è®°å½•ä¸€æ¬¡ï¼ˆä»…æ´»è·ƒæŒä»“ï¼‰

**ç¤ºä¾‹æ•°æ®**:
```sql
-- 2026-02-04 10:00
INSERT INTO greeks_history (position_id, iv, delta)
VALUES ('uuid-123', 0.1778, 0.3999);

-- 2026-02-04 12:00
INSERT INTO greeks_history (position_id, iv, delta)
VALUES ('uuid-123', 0.1825, 0.4123);

-- 2026-02-04 14:00
INSERT INTO greeks_history (position_id, iv, delta)
VALUES ('uuid-123', 0.1756, 0.3876);
```

**è‡ªåŠ¨æ¸…ç†**: å½“æŒä»“å…³é—­æ—¶ï¼Œç›¸å…³å†å²è®°å½•è‡ªåŠ¨åˆ é™¤ï¼ˆCASCADEï¼‰

---

## ğŸ”— å…³ç³»è®¾è®¡

### ERå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     positions       â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)             â”‚
â”‚ ticker              â”‚
â”‚ strike              â”‚
â”‚ type                â”‚
â”‚ expiration          â”‚
â”‚ status              â”‚
â”‚ ...                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 1
           â”‚
           â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   transactions      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)             â”‚
â”‚ position_id (FK)    â”‚
â”‚ type                â”‚
â”‚ quantity            â”‚
â”‚ price               â”‚
â”‚ ...                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

           â”‚ 1
           â”‚
           â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  greeks_history     â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)             â”‚
â”‚ position_id (FK)    â”‚
â”‚ iv                  â”‚
â”‚ delta               â”‚
â”‚ recorded_at         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…³ç³»è¯´æ˜

**positions â†” transactions (1:N)**
- ä¸€ä¸ªæŒä»“å¯ä»¥æœ‰å¤šç¬”äº¤æ˜“
- åˆ é™¤æŒä»“æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤æ‰€æœ‰ç›¸å…³äº¤æ˜“ï¼ˆCASCADEï¼‰
- é€šè¿‡`position_id`å…³è”

**positions â†” greeks_history (1:N)**
- ä¸€ä¸ªæŒä»“å¯ä»¥æœ‰å¤šæ¡Greekså†å²è®°å½•
- åˆ é™¤æŒä»“æ—¶ï¼Œè‡ªåŠ¨åˆ é™¤æ‰€æœ‰å†å²è®°å½•ï¼ˆCASCADEï¼‰
- é€šè¿‡`position_id`å…³è”

---

## ğŸš€ ç´¢å¼•ç­–ç•¥

### ä¸»é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰

```sql
-- positionsè¡¨
CREATE UNIQUE INDEX positions_pkey ON positions(id);

-- transactionsè¡¨
CREATE UNIQUE INDEX transactions_pkey ON transactions(id);

-- greeks_historyè¡¨
CREATE UNIQUE INDEX greeks_history_pkey ON greeks_history(id);
```

### å¤–é”®ç´¢å¼•ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰

```sql
-- transactionsè¡¨
CREATE INDEX idx_transactions_position_id ON transactions(position_id);

-- greeks_historyè¡¨
CREATE INDEX idx_greeks_history_position_id ON greeks_history(position_id);
```

### ä¸šåŠ¡ç´¢å¼•ï¼ˆæ‰‹åŠ¨åˆ›å»ºï¼‰

```sql
-- æŒ‰çŠ¶æ€æŸ¥è¯¢ï¼ˆæœ€å¸¸ç”¨ï¼‰
CREATE INDEX idx_positions_status ON positions(status);

-- æŒ‰åˆ°æœŸæ—¥æŸ¥è¯¢ï¼ˆè­¦å‘Šç³»ç»Ÿï¼‰
CREATE INDEX idx_positions_expiration ON positions(expiration);

-- æŒ‰åˆ›å»ºæ—¶é—´æ’åº
CREATE INDEX idx_positions_created_at ON positions(created_at DESC);

-- æŒ‰äº¤æ˜“æ—¶é—´æ’åº
CREATE INDEX idx_transactions_date ON transactions(date DESC);

-- æŒ‰è®°å½•æ—¶é—´æŸ¥è¯¢Greekså†å²
CREATE INDEX idx_greeks_history_recorded_at ON greeks_history(recorded_at DESC);
```

### å¤åˆç´¢å¼•ï¼ˆä¼˜åŒ–ç‰¹å®šæŸ¥è¯¢ï¼‰

```sql
-- æŸ¥è¯¢ç‰¹å®šçŠ¶æ€çš„æŒä»“å¹¶æŒ‰åˆ›å»ºæ—¶é—´æ’åº
CREATE INDEX idx_positions_status_created ON positions(status, created_at DESC);

-- æŸ¥è¯¢ç‰¹å®šæŒä»“çš„äº¤æ˜“è®°å½•å¹¶æŒ‰æ—¶é—´æ’åº
CREATE INDEX idx_transactions_position_date ON transactions(position_id, date DESC);
```

---

## ğŸ” å®‰å…¨ç­–ç•¥

### Row Level Security (RLS)

**å¯ç”¨RLS**:
```sql
ALTER TABLE positions ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE greeks_history ENABLE ROW LEVEL SECURITY;
```

### å½“å‰ç­–ç•¥ï¼ˆå¼€å‘é˜¶æ®µï¼‰

**å…è®¸æ‰€æœ‰æ“ä½œ**ï¼ˆä¸´æ—¶ç­–ç•¥ï¼‰:
```sql
-- positionsè¡¨
CREATE POLICY "Allow all on positions" 
ON positions 
FOR ALL 
USING (true) 
WITH CHECK (true);

-- transactionsè¡¨
CREATE POLICY "Allow all on transactions" 
ON transactions 
FOR ALL 
USING (true) 
WITH CHECK (true);

-- greeks_historyè¡¨
CREATE POLICY "Allow all on greeks_history" 
ON greeks_history 
FOR ALL 
USING (true) 
WITH CHECK (true);
```

### ç”Ÿäº§ç¯å¢ƒç­–ç•¥ï¼ˆæœªæ¥ï¼‰

**ç”¨æˆ·éš”ç¦»**:
```sql
-- æ·»åŠ user_idåˆ—
ALTER TABLE positions ADD COLUMN user_id UUID REFERENCES auth.users(id);

-- åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
CREATE POLICY "Users can only access their own positions"
ON positions
FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);

-- transactionså’Œgreeks_historyé€šè¿‡JOINç»§æ‰¿æƒé™
CREATE POLICY "Users can only access their own transactions"
ON transactions
FOR ALL
USING (
  EXISTS (
    SELECT 1 FROM positions 
    WHERE positions.id = transactions.position_id 
    AND positions.user_id = auth.uid()
  )
);
```

---

## ğŸ“ è¿ç§»å†å²

### Migration 001: åˆå§‹åŒ–è¡¨ç»“æ„

**æ—¥æœŸ**: 2026-01-15

**SQL**:
```sql
-- åˆ›å»ºpositionsè¡¨
CREATE TABLE positions (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    ticker VARCHAR(20) NOT NULL,
    strike DECIMAL(10,2) NOT NULL,
    type VARCHAR(10) NOT NULL CHECK (type IN ('Call', 'Put')),
    expiration DATE NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'watchlist' CHECK (status IN ('watchlist', 'active', 'closed')),
    setup VARCHAR(50),
    entry_score INTEGER,
    current_score INTEGER,
    score_updated_at TIMESTAMPTZ,
    ideal_entry DECIMAL(10,2),
    current_price DECIMAL(10,2),
    stop_reason TEXT,
    target_price DECIMAL(10,2),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    closed_at TIMESTAMPTZ
);

-- åˆ›å»ºtransactionsè¡¨
CREATE TABLE transactions (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    position_id UUID REFERENCES positions(id) ON DELETE CASCADE,
    type VARCHAR(20) NOT NULL CHECK (type IN ('Open', 'Size Up', 'Size Down', 'Take Profit', 'Close')),
    quantity INTEGER NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    date TIMESTAMPTZ DEFAULT NOW(),
    note TEXT
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_positions_status ON positions(status);
CREATE INDEX idx_transactions_position_id ON transactions(position_id);

-- å¯ç”¨RLS
ALTER TABLE positions ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºç­–ç•¥
CREATE POLICY "Allow all on positions" ON positions FOR ALL USING (true) WITH CHECK (true);
CREATE POLICY "Allow all on transactions" ON transactions FOR ALL USING (true) WITH CHECK (true);
```

---

### Migration 002: æ·»åŠ Greekså†å²è¡¨

**æ—¥æœŸ**: 2026-02-03

**SQL**:
```sql
-- åˆ›å»ºposition_greeks_historyè¡¨
CREATE TABLE position_greeks_history (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    position_id UUID REFERENCES positions(id) ON DELETE CASCADE,
    iv DECIMAL(6,4) NOT NULL CHECK (iv >= 0 AND iv <= 5),
    delta DECIMAL(6,4) NOT NULL CHECK (delta >= -1 AND delta <= 1),
    recorded_at TIMESTAMPTZ DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_position_greeks_history_position_id ON position_greeks_history(position_id);
CREATE INDEX idx_position_greeks_history_recorded_at ON position_greeks_history(recorded_at DESC);

-- å¯ç”¨RLS
ALTER TABLE position_greeks_history ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºç­–ç•¥
CREATE POLICY "Allow all on position_greeks_history" ON position_greeks_history FOR ALL USING (true) WITH CHECK (true);
```

---

## ğŸ”§ å¸¸ç”¨æŸ¥è¯¢

### æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒæŒä»“åŠå…¶äº¤æ˜“è®°å½•

```sql
SELECT 
    p.*,
    json_agg(
        json_build_object(
            'id', t.id,
            'type', t.type,
            'quantity', t.quantity,
            'price', t.price,
            'date', t.date,
            'note', t.note
        ) ORDER BY t.date DESC
    ) AS transactions
FROM positions p
LEFT JOIN transactions t ON p.id = t.position_id
WHERE p.status = 'active'
GROUP BY p.id
ORDER BY p.created_at DESC;
```

### è®¡ç®—æŒä»“çš„P&L

```sql
WITH position_stats AS (
    SELECT 
        position_id,
        SUM(CASE WHEN quantity > 0 THEN quantity * price ELSE 0 END) / 
        NULLIF(SUM(CASE WHEN quantity > 0 THEN quantity ELSE 0 END), 0) AS avg_cost,
        SUM(quantity) AS current_quantity
    FROM transactions
    GROUP BY position_id
)
SELECT 
    p.ticker,
    p.strike,
    p.type,
    p.current_price,
    ps.avg_cost,
    ps.current_quantity,
    (p.current_price - ps.avg_cost) * ps.current_quantity * 100 AS unrealized_pnl
FROM positions p
JOIN position_stats ps ON p.id = ps.position_id
WHERE p.status = 'active';
```

### æŸ¥è¯¢Greekså†å²ï¼ˆæœ€è¿‘7å¤©ï¼‰

```sql
SELECT 
    position_id,
    iv,
    delta,
    recorded_at
FROM greeks_history
WHERE position_id = 'uuid-123'
  AND recorded_at >= NOW() - INTERVAL '7 days'
ORDER BY recorded_at ASC;
```

### ç»Ÿè®¡äº¤æ˜“ç»©æ•ˆ

```sql
SELECT 
    COUNT(*) AS total_trades,
    COUNT(CASE WHEN status = 'closed' THEN 1 END) AS closed_trades,
    AVG(EXTRACT(EPOCH FROM (closed_at - created_at)) / 86400) AS avg_hold_days
FROM positions
WHERE status = 'closed';
```

---

## ğŸ—‘ï¸ æ•°æ®æ¸…ç†

### åˆ é™¤æ—§çš„Greekså†å²ï¼ˆä¿ç•™30å¤©ï¼‰

```sql
DELETE FROM greeks_history
WHERE recorded_at < NOW() - INTERVAL '30 days';
```

### å½’æ¡£å·²å¹³ä»“æŒä»“ï¼ˆè¶…è¿‡90å¤©ï¼‰

```sql
-- åˆ›å»ºå½’æ¡£è¡¨
CREATE TABLE positions_archive (LIKE positions INCLUDING ALL);

-- ç§»åŠ¨æ•°æ®
INSERT INTO positions_archive
SELECT * FROM positions
WHERE status = 'closed' 
  AND closed_at < NOW() - INTERVAL '90 days';

-- åˆ é™¤åŸæ•°æ®
DELETE FROM positions
WHERE status = 'closed' 
  AND closed_at < NOW() - INTERVAL '90 days';
```

---

## ğŸ“Š æ•°æ®åº“ç›‘æ§

### è¡¨å¤§å°æŸ¥è¯¢

```sql
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### ç´¢å¼•ä½¿ç”¨æƒ…å†µ

```sql
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan AS index_scans,
    idx_tup_read AS tuples_read,
    idx_tup_fetch AS tuples_fetched
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

---

*æ–‡æ¡£ç»´æŠ¤è€…: Trading Journal Team*
*æœ€åæ›´æ–°: 2026å¹´2æœˆ6æ—¥*
