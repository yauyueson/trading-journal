# Trading Journal - æ ¸å¿ƒç®—æ³•è¯¦è§£

> æœ€åæ›´æ–°: 2026å¹´2æœˆ6æ—¥

## ğŸ“‹ ç›®å½•

1. [OSSè¯„åˆ†ç³»ç»Ÿæ¦‚è¿°](#ossè¯„åˆ†ç³»ç»Ÿæ¦‚è¿°)
2. [LOQç®—æ³•ï¼ˆä¹°æ–¹è¯„åˆ†ï¼‰](#loqç®—æ³•ä¹°æ–¹è¯„åˆ†)
3. [CSQç®—æ³•ï¼ˆå–æ–¹è¯„åˆ†ï¼‰](#csqç®—æ³•å–æ–¹è¯„åˆ†)
4. [IVæœŸé™ç»“æ„åˆ†æ](#ivæœŸé™ç»“æ„åˆ†æ)
5. [è­¦å‘Šç³»ç»Ÿç®—æ³•](#è­¦å‘Šç³»ç»Ÿç®—æ³•)
6. [P&Lè®¡ç®—ç®—æ³•](#plè®¡ç®—ç®—æ³•)

---

## ğŸ¯ OSSè¯„åˆ†ç³»ç»Ÿæ¦‚è¿°

### Options Scoring System (OSS)

**ç‰ˆæœ¬**: 2.2 (Volatility Risk Premium Optimized)

**v2.2 æ–°å¢**:
- **IV/RV Ratio (VRP)**: æ•´åˆéšå«æ³¢åŠ¨ç‡ä¸å†å²æ³¢åŠ¨ç‡ä¹‹æ¯”ï¼Œé‡åŒ–æ³¢åŠ¨ç‡é£é™©æº¢ä»·ã€‚
- **Deal Breaker Filter**: å¢åŠ æµåŠ¨æ€§ç¡¬çº¦æŸï¼Œä¹°å–ä»·å·®ç‡ > 15% çš„æœŸæƒè‡ªåŠ¨å½’é›¶ã€‚
- **Batch API Data Flow**: ä¼˜åŒ–æŒä»“åŒæ­¥é€»è¾‘ï¼Œæ”¯æŒæ‰¹é‡æ•°æ®è·å–å¹¶å‡å°‘ API è°ƒç”¨ã€‚
- **Theta Pain Cap**: æƒ©ç½šå°é¡¶ä» 50 åˆ†è°ƒæ•´ä¸º 10 åˆ†ï¼Œå¹³è¡¡æ€§æ›´ä½³ã€‚

**æ ¸å¿ƒç†å¿µ**: 
é€šè¿‡é‡åŒ–æŒ‡æ ‡è¯„ä¼°æœŸæƒè´¨é‡ï¼Œé¿å…ä¸»è§‚åˆ¤æ–­å’Œæƒ…ç»ªåŒ–å†³ç­–ã€‚

**ä¸¤å¤§è¯„åˆ†ç³»ç»Ÿ**:
1. **LOQ** (Long Option Quality) - ä¹°æ–¹è¯„åˆ†
2. **CSQ** (Credit Spread Quality) - å–æ–¹è¯„åˆ†

**è¯„åˆ†èŒƒå›´**: 0-100åˆ†
- **80-100**: ä¼˜ç§€æœºä¼š
- **70-79**: è‰¯å¥½æœºä¼š
- **60-69**: ä¸€èˆ¬æœºä¼š
- **<60**: ä¸å»ºè®®äº¤æ˜“

---

## ğŸ“ˆ LOQç®—æ³•ï¼ˆä¹°æ–¹è¯„åˆ†ï¼‰

### 1. æ ¸å¿ƒæŒ‡æ ‡

#### Lambda (Î›) - çœŸå®æ æ†ç‡

**å®šä¹‰**: è¡¡é‡æœŸæƒçš„èµ„æœ¬æ•ˆç‡

**å…¬å¼**:
```
Lambda = |Delta| Ã— (Stock Price / Option Price)
```

**è§£é‡Š**:
- é«˜Lambda = é«˜æ æ†ï¼Œå°èµ„æœ¬æ§åˆ¶å¤§æ•å£
- ä¾‹: Delta=0.4, è‚¡ä»·=$620, æœŸæƒä»·=$7.36
  - Lambda = 0.4 Ã— (620 / 7.36) = 33.7
  - æ„å‘³ç€$1æœŸæƒä»·æ ¼å˜åŠ¨ç›¸å½“äº$33.7è‚¡ç¥¨æ•å£

**ç†æƒ³èŒƒå›´**: 5-15
- <5: æ æ†ä¸è¶³ï¼Œä¸å¦‚ä¹°è‚¡ç¥¨
- 5-15: é»„é‡‘åŒºé—´
- >20: è¿‡åº¦æ æ†ï¼Œè§¦å‘**å¹³æ»‘å‹ç¼© (Soft Compression)**

#### Lambda Soft Compression (å¹³æ»‘å‹ç¼©)

**ç›®çš„**: é¿å…æä½ä»·æ ¼æœŸæƒäº§ç”Ÿå¤©æ–‡æ•°å­—çº§çš„ Lambda ä»è€Œæ‰­æ›² Z-Scoreã€‚

**å…¬å¼**:
```
if (lambda <= 20):
  processed_lambda = lambda
else:
  processed_lambda = 20 + (lambda - 20) * 0.1
```

**æ•ˆæœ**: Lambda=50 å®é™…è¢«å‹ç¼©ä¸º 23ï¼Œæ—¢ä¿ç•™äº†æ’åä¼˜åŠ¿ï¼Œåˆé˜²æ­¢äº†æ•°æ®çˆ†ç‚¸ã€‚

**ä»£ç å®ç°**:
```typescript
export function calculateLambda(
  delta: number, 
  stockPrice: number, 
  optionPrice: number
): number {
  if (optionPrice <= 0) return 0;
  return Math.abs(delta) * (stockPrice / optionPrice);
}
```

---

#### Gamma Efficiency (Î“eff) - çˆ†å‘åŠ›

**å®šä¹‰**: å•ä½ä»·æ ¼çš„DeltaåŠ é€Ÿåº¦

**å…¬å¼**:
```
Gamma Efficiency = Gamma / Option Price
```

**è§£é‡Š**:
- é«˜Gamma Eff = Deltaå¿«é€Ÿå¢é•¿ï¼Œæœ‰åˆ©æ–¹å‘ç§»åŠ¨æ—¶æ”¶ç›ŠåŠ é€Ÿ
- ä¾‹: Gamma=0.0123, æœŸæƒä»·=$7.36
  - Gamma Eff = 0.0123 / 7.36 = 0.00167
  - è‚¡ä»·æ¯æ¶¨$1ï¼ŒDeltaå¢åŠ 0.0123

**ç†æƒ³èŒƒå›´**: 0.01-0.05
- <0.01: Deltaå˜åŒ–å¤ªæ…¢
- 0.01-0.05: é»„é‡‘åŒºé—´
- >0.05: è¿‡åº¦æ•æ„Ÿï¼Œé£é™©é«˜

**ä»£ç å®ç°**:
```typescript
export function calculateGammaEfficiency(
  gamma: number, 
  optionPrice: number
): number {
  if (optionPrice <= 0) return 0;
  return gamma / optionPrice;
}
```

---

#### Theta Burn (TB) - æ—¶é—´è¡°å‡ç‡

**å®šä¹‰**: æ¯æ—¥æ—¶é—´ä»·å€¼æŸå¤±ç‡

**å…¬å¼**:
```
Theta Burn = |Theta| / Option Price
```

**è§£é‡Š**:
- ä½Theta Burn = æ¯æ—¥æŸå¤±å°‘ï¼Œé€‚åˆæŒæœ‰
- ä¾‹: Theta=-0.0456, æœŸæƒä»·=$7.36
  - Theta Burn = 0.0456 / 7.36 = 0.0062 (0.62%/å¤©)
  - æ¯å¤©æŸå¤±0.62%çš„æœŸæƒä»·å€¼

**ç†æƒ³èŒƒå›´**: 0-0.05
- <0.02: ä¼˜ç§€ï¼ˆ<2%/å¤©ï¼‰
- 0.02-0.05: å¯æ¥å—
- >0.05: æ—¶é—´è¡°å‡è¿‡å¿«

**ä»£ç å®ç°**:
```typescript
export function calculateThetaBurn(
  theta: number, 
  optionPrice: number
): number {
  if (optionPrice <= 0) return 0;
  return Math.abs(theta) / optionPrice;
}
```

---

#### Theta Pain Curve - æŒ‡æ•°å‹æƒ©ç½š (v2.2 æ–°å¢)

**å®šä¹‰**: å¯¹é«˜æ—¶é—´è¡°å‡çš„éçº¿æ€§æƒ©ç½š

**è®¾è®¡ç†å¿µ**:
- å®‰å…¨åŒº (â‰¤0.5%/å¤©): é›¶æƒ©ç½šï¼Œå¯¹ LEAPS å‹å¥½
- è¶…å‡ºå®‰å…¨åŒº: æƒ©ç½šå‘ˆäºŒæ¬¡å¢é•¿
- å°é¡¶ 50 åˆ†ï¼Œé˜²æ­¢æç«¯å€¼ç‚¸ç©¿è¯„åˆ†

**å…¬å¼**:
```
if (thetaBurn <= 0.005):
  penalty = 0
else:
  excess = thetaBurn - 0.005
  penalty = min((excess Ã— 100)Â² Ã— 0.5, 10)
```

**ç¤ºä¾‹**:
```
0.3%/å¤© â†’ 0 (å®‰å…¨)
1.0%/å¤© â†’ 0.125 åˆ†
3.0%/å¤© â†’ 3.125 åˆ†
6.0%/å¤© â†’ 10.000 åˆ† (å°é¡¶)
```

**ä»£ç å®ç°**:
```typescript
export function getThetaPenalty(thetaBurn: number): number {
  const SAFE_ZONE = 0.005; 
  
  if (thetaBurn <= SAFE_ZONE) {
    return 0;
  }
  
  const excess = thetaBurn - SAFE_ZONE;
  const penalty = Math.pow(excess * 100, 2) * 0.5;
  
  return Math.min(penalty, 10);
}
```

---

#### Delta Bonus - ATMå¥–åŠ±

**å®šä¹‰**: å¥–åŠ±ATMæœŸæƒï¼Œæƒ©ç½šå½©ç¥¨å¼æœŸæƒ

**è§„åˆ™ (LERP çº¿æ€§æ’å€¼)**:
ä¸ºäº†é¿å… Delta åœ¨ 0.14 å’Œ 0.15 ä¹‹é—´äº§ç”Ÿå·¨å¤§çš„è¯„åˆ†åˆ†æ°´å²­ï¼Œæˆ‘ä»¬ä½¿ç”¨çº¿æ€§æ’å€¼ï¼š

- **|Î”| < 0.15**: -2.0 å®šå€¼ (å½©ç¥¨æƒ©ç½š)
- **|Î”| 0.15 - 0.30**: ä» -2.0 çº¿æ€§è¿‡æ¸¡åˆ° -0.5
- **|Î”| 0.30 - 0.50**: ä» -0.5 çº¿æ€§è¿‡æ¸¡åˆ° +1.0 (ç”œèœœåŒº)
- **|Î”| 0.50 - 0.70**: ä» +1.0 çº¿æ€§è¿‡æ¸¡åˆ° +0.5
- **|Î”| > 0.70**: ä» +0.5 çº¿æ€§è¿‡æ¸¡åˆ° 0 (æ·±åº¦ ITM)

**ä»£ç å®ç°**:
```typescript
export function getDeltaBonus(delta: number): number {
  const absDelta = Math.abs(delta);
  const lerp = (x, x1, x2, y1, y2) => y1 + (y2 - y1) * ((x - x1) / (x2 - x1));

  if (absDelta < 0.15) return -2.0;
  if (absDelta < 0.30) return lerp(absDelta, 0.15, 0.30, -2.0, -0.5);
  if (absDelta < 0.50) return lerp(absDelta, 0.30, 0.50, -0.5, 1.0);
  if (absDelta < 0.70) return lerp(absDelta, 0.50, 0.70, 1.0, 0.5);
  return lerp(absDelta, 0.70, 1.0, 0.5, 0);
}
```

---

### 2. Z-Scoreæ ‡å‡†åŒ–

**ç›®çš„**: å°†ä¸åŒé‡çº²çš„æŒ‡æ ‡è½¬æ¢ä¸ºå¯æ¯”è¾ƒçš„æ ‡å‡†åˆ†æ•°

**å…¬å¼**:
```
Z = (x - Î¼) / Ïƒ

å…¶ä¸­:
- x: åŸå§‹å€¼
- Î¼: å¹³å‡å€¼
- Ïƒ: æ ‡å‡†å·®
```

**æµç¨‹**:
1. æ”¶é›†æ‰€æœ‰å€™é€‰æœŸæƒçš„Lambdaã€Gamma Effã€Theta Burn
2. è®¡ç®—æ¯ä¸ªæŒ‡æ ‡çš„å‡å€¼å’Œæ ‡å‡†å·®
3. è½¬æ¢ä¸ºZ-Scoreï¼ˆå‡å€¼=0ï¼Œæ ‡å‡†å·®=1ï¼‰

**ä»£ç å®ç°**:
```typescript
function mean(values: number[]): number {
  return values.reduce((sum, v) => sum + v, 0) / values.length;
}

function stdDev(values: number[]): number {
  const avg = mean(values);
  const squaredDiffs = values.map(v => Math.pow(v - avg, 2));
  return Math.sqrt(mean(squaredDiffs)) || 1;
}

export function normalizeToZScores(values: number[]): number[] {
  const avg = mean(values);
  const std = stdDev(values);
  return values.map(v => (v - avg) / std);
}
```

**ç¤ºä¾‹**:
```
åŸå§‹Lambda: [5.2, 8.7, 12.3, 15.1, 18.9]
å‡å€¼: 12.04
æ ‡å‡†å·®: 5.12
Z-Scores: [-1.34, -0.65, 0.05, 0.60, 1.34]
```

---

### 3. LOQåŠ æƒè®¡ç®—

**æƒé‡é…ç½® (Standard Mode)**:
```typescript
const LOQ_WEIGHTS = {
  lambda: 0.40,      // æ æ†ç‡ï¼ˆå›ºå®šæƒé‡ï¼‰
  gammaEff: 0.30,    // çˆ†å‘åŠ›
  thetaBurn: -0.15,  // æ—¶é—´è¡°å‡ï¼ˆè´Ÿæƒé‡ï¼‰
  deltaBonus: 0.15   // çº¿æ€§æ’å€¼å¥–åŠ±
};
```

**æƒé‡é…ç½® (Day Trade Mode)**:
*å½“ DTE â‰¤ 5 ä¸”å¼€å¯æ—¥å†…æ¨¡å¼æ—¶è§¦å‘*
```typescript
const DT_WEIGHTS = {
  lambda: 0.40,
  gammaEff: 0.50,    // æå¤§å¼ºåŒ–çˆ†å‘åŠ›è¦æ±‚
  thetaBurn: -0.05,  // å¼±åŒ–æ—¶é—´è¡°å‡ï¼ˆæ—¥å†…æŒæœ‰å½±å“å°ï¼‰
  penaltyMult: 0.2   // Theta Pain æƒ©ç½šå‡å¼± 80%
};
```

**å…¬å¼** (v2.2 æ›´æ–°):
```
LOQ_Raw = 0.40Ã—z(Î›) + 0.30Ã—z(Î“eff) - 0.15Ã—z(TB) + 0.15Ã—Î”Bonus + IV_Adj - ThetaPainPenalty

å…¶ä¸­:
- z(Î›): Lambdaçš„Z-Score
- z(Î“eff): Gamma Efficiencyçš„Z-Score
- z(TB): Theta Burnçš„Z-Score
- Î”Bonus: Deltaå¥–åŠ±/æƒ©ç½š
- IV_Adj: IVæœŸé™ç»“æ„è°ƒæ•´ï¼ˆä½¿ç”¨ Sigmoid å¹³æ»‘è¿‡æ¸¡ï¼‰
- ThetaPainPenalty: æŒ‡æ•°å‹ Theta æƒ©ç½šï¼ˆå¯¹æœ«æ—¥è½®çš„é¢å¤–æƒ©ç½šï¼‰
```

**ä»£ç å®ç°**:
```typescript
export function calculateLOQRaw(
  zLambda: number,
  zGammaEff: number,
  zThetaBurn: number,
  ivAdjustment: number,
  deltaBonus: number = 0,
  thetaBurn: number = 0
): number {
  const thetaPenalty = getThetaPenalty(thetaBurn);
  
  return (
    LOQ_WEIGHTS.lambda * zLambda +
    LOQ_WEIGHTS.gammaEff * zGammaEff +
    LOQ_WEIGHTS.thetaBurn * zThetaBurn +
    LOQ_WEIGHTS.deltaBonus * deltaBonus +
    ivAdjustment -
    thetaPenalty
  );
}
```

---

### 4. è½¬æ¢ä¸º0-100åˆ†

**æ˜ å°„å‡½æ•°**:
```
Score = 50 + (LOQ_Raw Ã— 12.5)
Clamped to [0, 100]
```

**åŸç†**:
- åŸå§‹åˆ†æ•°èŒƒå›´çº¦ä¸º [-4, 4]
- æ˜ å°„åˆ° [0, 100]ï¼Œä¸­ä½æ•°50åˆ†
- Z-Score=0 â†’ 50åˆ†
- Z-Score=+2 â†’ 75åˆ†
- Z-Score=+4 â†’ 100åˆ†

**ä»£ç å®ç°**:
```typescript
export function normalizeScoreTo100(rawScore: number): number {
  const scaled = 50 + rawScore * 12.5;
  return Math.max(0, Math.min(100, Math.round(scaled)));
}
```

---

### 5. å®Œæ•´ç¤ºä¾‹

**è¾“å…¥æ•°æ®**:
```typescript
const option = {
  ticker: 'QQQ',
  strike: 630,
  type: 'Call',
  expiration: '2026-02-20',
  delta: 0.3999,
  gamma: 0.0123,
  theta: -0.0456,
  bid: 7.32,
  ask: 7.39,
  stockPrice: 620.24
};
```

**è®¡ç®—è¿‡ç¨‹**:
```typescript
// 1. è®¡ç®—åŸå§‹æŒ‡æ ‡
const mid = (7.32 + 7.39) / 2 = 7.355;
const lambda = 0.3999 Ã— (620.24 / 7.355) = 33.7;
const gammaEff = 0.0123 / 7.355 = 0.00167;
const thetaBurn = 0.0456 / 7.355 = 0.0062;
const deltaBonus = getDeltaBonus(0.3999) = 1.0; // åœ¨ç”œèœœåŒº

// 2. Z-Scoreæ ‡å‡†åŒ–ï¼ˆå‡è®¾åœ¨æœŸæƒé“¾ä¸­ï¼‰
const zLambda = 1.2;   // é«˜äºå¹³å‡
const zGammaEff = 0.8; // ç•¥é«˜äºå¹³å‡
const zThetaBurn = -0.5; // ä½äºå¹³å‡ï¼ˆå¥½äº‹ï¼‰

// 3. åŠ æƒè®¡ç®—
const rawScore = 
  0.40 Ã— 1.2 +      // Lambdaè´¡çŒ®: 0.48
  0.30 Ã— 0.8 +      // Gammaè´¡çŒ®: 0.24
  -0.15 Ã— (-0.5) +  // Thetaè´¡çŒ®: 0.075
  0.15 Ã— 1.0 +      // Deltaè´¡çŒ®: 0.15
  0.5;              // IVè°ƒæ•´: 0.5 (Contangoå¥–åŠ±)
  = 1.445

// 4. è½¬æ¢ä¸º0-100åˆ†
const score = 50 + 1.445 Ã— 12.5 = 68åˆ†
```

**ç»“æœè§£è¯»**: 68åˆ† - ä¸€èˆ¬æœºä¼šï¼Œå¯ä»¥è€ƒè™‘ä½†ä¸æ˜¯æœ€ä¼˜

---

## ğŸ“‰ CSQç®—æ³•ï¼ˆå–æ–¹è¯„åˆ†ï¼‰

### 1. æ ¸å¿ƒæŒ‡æ ‡

#### POP (Probability of Profit)

**å®šä¹‰**: æœŸæƒåˆ°æœŸæ—¶ç›ˆåˆ©çš„æ¦‚ç‡

**å…¬å¼**:
```
POP = 1 - |Delta|
```

**è§£é‡Š**:
- Deltaè¿‘ä¼¼ä¸ºITMæ¦‚ç‡
- POP = OTMæ¦‚ç‡ï¼ˆå–æ–¹ç›ˆåˆ©ï¼‰
- ä¾‹: Delta=0.30 â†’ POP=0.70 (70%ç›ˆåˆ©æ¦‚ç‡)

**ä»£ç å®ç°**:
```typescript
export function calculatePOP(delta: number): number {
  return 1 - Math.abs(delta);
}
```

---

#### Seller's Edge - å–æ–¹ä¼˜åŠ¿

**å®šä¹‰**: æœŸæœ›æ”¶ç›Š

**å…¬å¼**:
```
Edge = POP Ã— Premium Received
```

**è§£é‡Š**:
- ç»“åˆæ¦‚ç‡å’Œæ”¶ç›Šçš„æœŸæœ›å€¼
- ä¾‹: POP=0.70, Premium=$2.50
  - Edge = 0.70 Ã— 2.50 = $1.75
  - æœŸæœ›æ¯ä»½åˆçº¦èµš$1.75

**ä»£ç å®ç°**:
```typescript
export function calculateSellerEdge(pop: number, premium: number): number {
  return pop * premium;
}
```

---

#### Spread Percentage - æµåŠ¨æ€§

**å®šä¹‰**: ä¹°å–ä»·å·®å æ¯”

**å…¬å¼**:
```
Spread% = (Ask - Bid) / Mid
```

**è§£é‡Š**:
- ä½Spread = é«˜æµåŠ¨æ€§ï¼Œæ˜“æˆäº¤
- ä¾‹: Bid=$2.45, Ask=$2.55
  - Mid = $2.50
  - Spread% = 0.10 / 2.50 = 4%

**ç†æƒ³èŒƒå›´**: <10%
- <5%: ä¼˜ç§€æµåŠ¨æ€§
- 5-10%: å¯æ¥å—
- >10%: æµåŠ¨æ€§å·®

**ä»£ç å®ç°**:
```typescript
export function calculateSpreadPct(bid: number, ask: number): number {
  const mid = (bid + ask) / 2;
  if (mid <= 0) return 1; // 100% = æ— æµåŠ¨æ€§
  return (ask - bid) / mid;
}
```

---

### 2. CSQåŠ æƒè®¡ç®—

**æƒé‡é…ç½®**:
```typescript
const CSQ_WEIGHTS = {
  edge: 0.50,      // å–æ–¹ä¼˜åŠ¿ï¼ˆæœ€é‡è¦ï¼‰
  pop: 0.30,       // ç›ˆåˆ©æ¦‚ç‡
  spread: -0.20    // æµåŠ¨æ€§ï¼ˆè´Ÿæƒé‡ï¼Œä½spreadæ›´å¥½ï¼‰
};
```

**å…¬å¼**:
```
CSQ_Raw = 0.50Ã—z(Edge) + 0.30Ã—z(POP) - 0.20Ã—z(Spread) + IV_Adj
```

**ä»£ç å®ç°**:
```typescript
export function calculateCSQRaw(
  zEdge: number,
  zPOP: number,
  zSpread: number,
  ivAdjustment: number
): number {
  return (
    CSQ_WEIGHTS.edge * zEdge +
    CSQ_WEIGHTS.pop * zPOP +
    CSQ_WEIGHTS.spread * zSpread +
    ivAdjustment
  );
}
```

---

## ğŸŒ¡ï¸ IVæœŸé™ç»“æ„åˆ†æ

### 1. 4-Card Method

**ç›®çš„**: åˆ¤æ–­å¸‚åœºæ³¢åŠ¨ç‡ç¯å¢ƒ

**æ–¹æ³•**: æ¯”è¾ƒ30å¤©å’Œ90å¤©ATM IV

**æ­¥éª¤**:
1. æ‰¾åˆ°30å¤©åˆ°æœŸçš„ATM Callå’ŒPut
2. å¹³å‡å¾—åˆ°IV_30
3. æ‰¾åˆ°90å¤©åˆ°æœŸçš„ATM Callå’ŒPut
4. å¹³å‡å¾—åˆ°IV_90
5. è®¡ç®—æ¯”ç‡: IV_Ratio = IV_30 / IV_90

**ä»£ç å®ç°**:
```typescript
function getATMIV(
  chain: OptionData[],
  currentPrice: number,
  targetDTE: number,
  tolerance: number = 10
): number | null {
  // 1. ç­›é€‰ç›®æ ‡DTEé™„è¿‘çš„Call
  const candidates = chain.filter(
    opt => opt.type === 'Call' && Math.abs(opt.dte - targetDTE) <= tolerance
  );
  
  if (candidates.length < 2) return null;
  
  // 2. æŒ‰è¡Œæƒä»·æ’åº
  candidates.sort((a, b) => a.strike - b.strike);
  
  // 3. æ‰¾åˆ°å¤¹ä½å½“å‰ä»·æ ¼çš„ä¸¤ä¸ªè¡Œæƒä»·
  for (let i = 0; i < candidates.length - 1; i++) {
    if (candidates[i].strike <= currentPrice && 
        candidates[i + 1].strike >= currentPrice) {
      return (candidates[i].iv + candidates[i + 1].iv) / 2;
    }
  }
  
  // 4. é™çº§ï¼šä½¿ç”¨æœ€æ¥è¿‘çš„è¡Œæƒä»·
  const closest = candidates.reduce((prev, curr) =>
    Math.abs(curr.strike - currentPrice) < Math.abs(prev.strike - currentPrice) 
      ? curr : prev
  );
  return closest.iv;
}

export function calculateIVRatio(
  chain: OptionData[], 
  currentPrice: number
): IVTermResult {
  const iv30 = getATMIV(chain, currentPrice, 30);
  const iv90 = getATMIV(chain, currentPrice, 90);
  
  if (!iv30 || !iv90 || iv90 === 0) {
    return { ivRatio: 1.0, iv30, iv90, status: 'neutral' };
  }
  
  const ratio = iv30 / iv90;
  
  let status: 'contango' | 'neutral' | 'backwardation';
  if (ratio < 0.95) {
    status = 'contango';      // è¿‘æœŸIVä½ï¼Œé€‚åˆä¹°å…¥
  } else if (ratio > 1.05) {
    status = 'backwardation';  // è¿‘æœŸIVé«˜ï¼Œé€‚åˆå–å‡º
  } else {
    status = 'neutral';        // æ­£å¸¸çŠ¶æ€
  }
  
  return { ivRatio: ratio, iv30, iv90, status };
}
```

---

### 2. Volatility Regime Matrix (æ³¢åŠ¨ç‡æœºåˆ¶çŸ©é˜µ)

**ç‰ˆæœ¬**: v2.2 (Harmony Update)

**æ ¸å¿ƒç†å¿µ**: 
ä¸å†ç®€å•åœ°å åŠ  IV Term Structure (IV30/IV90) å’Œ IV/RV Ratio (VRP) çš„åˆ†æ•°ï¼Œè€Œæ˜¯å°†ä¸¤è€…ç»“åˆæˆä¸€ä¸ª **4è±¡é™å†³ç­–çŸ©é˜µ**ã€‚è¿™ç§éçº¿æ€§é€»è¾‘èƒ½æœ‰æ•ˆåŒºåˆ†â€œä»·å€¼æœºä¼šâ€ä¸â€œæ³¢åŠ¨é™·é˜±â€ã€‚

#### çŸ©é˜µåˆ†å¸ƒä¸å†³ç­–

| è±¡é™ | æ¡ä»¶ 1 (Term Structure) | æ¡ä»¶ 2 (IV/RV Ratio) | çŠ¶æ€ | å†³ç­–å»ºè®® | LOQ/CSQ è°ƒæ•´åˆ† |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **1. Value Zone** | **Contango** (è¿‘æœŸIVä½) | **Low VRP** (IV < RV) | **ç»å¯¹ä»·å€¼** | å¼ºçƒˆä¹°å…¥ (Strong Buy) | +2.5 / -2.5 |
| **2. Momentum Zone** | **Backwardation** (è¿‘æœŸIVé«˜) | **Low VRP** (IV < RV) | **åŠ¨é‡æ‰©å¼ ** | æŠ•æœºä¹°å…¥ (Chase Move) | +1.0 / -1.0 |
| **3. Trap Zone** | **Contango** (è¿‘æœŸIVä½) | **High VRP** (IV > RV) | **ä»·å€¼é™·é˜±** | è§‚æœ›/é¿å¼€ (Avoid Trap) | -2.0 / +2.0 |
| **4. Fear Zone** | **Backwardation** (è¿‘æœŸIVé«˜) | **High VRP** (IV > RV) | **æç«¯ææ…Œ** | å¼ºçƒˆå–å‡º (Strong Sell) | -3.0 / +3.0 |

#### è±¡é™è¯¦è§£:

1.  **Value Zone (ä»·å€¼åŒº)**: 
    - æœŸæƒç›¸å¯¹äºå†å²ä»·æ ¼ï¼ˆ90å¤©ï¼‰ä¾¿å®œï¼Œä¸”ç›¸å¯¹äºå½“å‰å®é™…æ³¢åŠ¨ï¼ˆ20å¤©ï¼‰ä¹Ÿä¾¿å®œã€‚
    - è¿™æ˜¯ä¹°æ–¹æœ€å®Œç¾çš„å®‰å…¨è¾¹é™…ã€‚
2.  **Momentum Zone (åŠ¨é‡åŒº)**: 
    - è™½ç„¶è¿‘æœŸ IV æ¯” 90 å¤© IV é«˜ï¼ˆçœ‹ä¼¼è´µäº†ï¼‰ï¼Œä½†å®é™…ä¸Šè‚¡ä»·æ³¢åŠ¨çš„é€Ÿåº¦ï¼ˆRVï¼‰è¶…è¿‡äº† IV éšå«çš„é¢„æœŸã€‚
    - å±äºâ€œä¹°è´µä½†ç”±äºçˆ†å‘åŠ›å¤ªå¼ºä¾ç„¶å€¼å¾—ä¹°â€çš„åœºæ™¯ã€‚
3.  **Trap Zone (é™·é˜±åŒº)**: 
    - æœŸæƒçœ‹ä¼¼ä¾¿å®œï¼ˆè¿‘æœŸ IV ä½ï¼‰ï¼Œä½†å®é™…ä¸Šéšå«æ³¢åŠ¨ç‡ä¾ç„¶æ˜¾è‘—é«˜äºè‚¡ä»·å®é™…æ³¢åŠ¨ã€‚
    - åœ¨è¿™ç§å¹³æ·¡å¸‚åœºé‡Œä¹°å…¥æœŸæƒä¼šé¢ä¸´ä¸¥é‡çš„æ—¶é—´è™šè€—ï¼Œæ˜¯ä¹°æ–¹çš„â€œä»·å€¼å‘â€ã€‚
4.  **Fear Zone (ææ…ŒåŒº)**: 
    - å¸‚åœºæåº¦ææ…Œï¼ŒæœŸæƒä»·æ ¼ç›¸å¯¹äºå†å²å’Œç°å®éƒ½æåº¦é«˜æ˜‚ã€‚
    - å–æ–¹çš„å¤©å ‚ï¼Œé€šè¿‡å–å‡ºé«˜é¢æº¢ä»·è·å¾—æé«˜çš„èƒœç‡ã€‚

#### é€»è¾‘ä»£ç å®ç°:

```typescript
export function getVolatilityRegimeAdjustment(
    termStructureRatio: number,
    ivRvRatio: number,
    strategy: 'long' | 'short'
): number {
    const isContango = termStructureRatio < 1.0;
    const isBackwardation = termStructureRatio > 1.05;
    const isCheap = ivRvRatio < 0.95;
    const isExpensive = ivRvRatio > 1.1;

    let adj = 0;
    if (isContango && isCheap) adj = +2.5;         // Value
    else if (isBackwardation && isCheap) adj = +1.0; // Momentum
    else if (isContango && isExpensive) adj = -2.0;  // Trap
    else if (isBackwardation && isExpensive) adj = -3.0; // Fear
    else {
        // æ··åˆ/ä¸­æ€§åŒºï¼šé‡‡ç”¨çº¿æ€§æ’å€¼å¹³æ»‘å¤„ç†
        const termScore = (1 - termStructureRatio) * 5;
        const vrpScore = (1 - ivRvRatio) * 5;
        adj = (termScore + vrpScore) / 2;
    }

    return strategy === 'long' ? adj : -adj;
}
```

---

## ğŸš« äº¤æ˜“ç¡¬çº¦æŸ (Deal Breakers)

**å®šä¹‰**: åœ¨è®¡ç®—ä»»ä½•åˆ†æ•°å‰å¼ºåˆ¶è§¦å‘çš„é€€å‡ºæ¡ä»¶ã€‚

### 1. Liquidity Guard (æµåŠ¨æ€§å«å£«)

**è§„åˆ™**: ä¸ºäº†é˜²æ­¢ç”±äºé•¿è…¿ï¼ˆLong Legï¼‰æµåŠ¨æ€§æå·®å¯¼è‡´çš„æˆäº¤å›°éš¾ï¼Œç³»ç»Ÿåœ¨ v2.2.1 å¼•å…¥äº† **ç»„åˆå·®ä»·ç‡ï¼ˆComposite Spread %ï¼‰**ã€‚ä¸å†åªçœ‹çŸ­è…¿ï¼Œè€Œæ˜¯é€šè¿‡ç»„åˆçš„ä¹°å–ä»·å·®è¿›è¡Œç¡¬çº¦æŸã€‚

**å…¬å¼**:
```typescript
// ä¿¡ç”¨ä»·å·®ï¼šä¿å®ˆè®¡ç®—ç»„åˆä»·å·®
const spreadBid = shortLeg.bid - longLeg.ask; // å¹³ä»“æ—¶èƒ½è·å¾—çš„æœ€å·®ä¿¡ç”¨/ä¹°å…¥çš„æœ€å·®ä»·æ ¼
const spreadAsk = shortLeg.ask - longLeg.bid; // å¹³ä»“æ—¶éœ€è¦æ”¯ä»˜çš„æœ€å·®æˆæœ¬
const spreadMid = (spreadBid + spreadAsk) / 2;
const compositeSpreadPct = (spreadAsk - spreadBid) / spreadMid;

if (compositeSpreadPct > 0.15) {
  finalScore = 0; // å¼ºåˆ¶å½’é›¶
}
```

**æ„ä¹‰**: ä¿æŠ¤äº¤æ˜“è€…ä¸è¿›å…¥éš¾ä»¥å¹³ä»“ä¸”æ»‘ç‚¹å·¨å¤§çš„å¤´å¯¸ï¼Œç‰¹åˆ«æ˜¯å½“è¿œç«¯è¡Œæƒä»·æµåŠ¨æ€§æ¯ç«­æ—¶ã€‚

---

### 2. IVè°ƒæ•´è§„åˆ™ (v2.2 Sigmoid å¹³æ»‘è¿‡æ¸¡)

**è®¾è®¡ç†å¿µ**:
- å¸‚åœºæƒ…ç»ªåœ¨"å†·é™"å’Œ"ææ…Œ"ä¹‹é—´çªå˜
- ä½¿ç”¨ Sigmoid å‡½æ•°æ¨¡æ‹Ÿè¿™ç§ç›¸å˜
- k=12 æä¾›å¹³æ»‘ä½†æ˜ç¡®çš„è¿‡æ¸¡
- x0=1.10 ä½œä¸ºä¸´ç•Œç‚¹

**IV Risk Factor å…¬å¼**:
```
riskFactor = 0.9 + sigmoid(ratio, k=12, x0=1.10) Ã— 0.4

è¿”å›å€¼:
- ~0.9 = å®‰å…¨ (Contango, ratio < 1.0)
- ~1.0 = ä¸­æ€§ (ratio â‰ˆ 1.05)
- ~1.3 = å±é™© (Backwardation, ratio > 1.15)
```

**ä¹°æ–¹ï¼ˆLOQï¼‰è°ƒæ•´**:
```
IV_Adj = (1 - riskFactor) Ã— 5

- riskFactor=0.9 â†’ +0.5 (Contango å¥–åŠ±)
- riskFactor=1.0 â†’ 0 (ä¸­æ€§)
- riskFactor=1.3 â†’ -1.5 (Backwardation æƒ©ç½š)
```

**å–æ–¹ï¼ˆCSQï¼‰è°ƒæ•´**:
```
IV_Adj = (riskFactor - 1) Ã— 5

- riskFactor=0.9 â†’ -0.5 (Contango æƒ©ç½š)
- riskFactor=1.0 â†’ 0 (ä¸­æ€§)
- riskFactor=1.3 â†’ +1.5 (Backwardation å¥–åŠ±ï¼Œå–é«˜IV)
```

**ä»£ç å®ç°**:
```typescript
export function getIVRiskFactor(ratio: number): number {
  const k = 12;     // Steepness
  const x0 = 1.10;  // Critical point
  
  const raw = 1 / (1 + Math.exp(-k * (ratio - x0)));
  
  return 0.9 + raw * 0.4;
}

export function getIVAdjustment(ivRatio: number, strategy: Strategy): number {
  const riskFactor = getIVRiskFactor(ivRatio);
  
  if (strategy === 'long') {
    return (1 - riskFactor) * 5;
  } else {
    return (riskFactor - 1) * 5;
  }
}
```

---

## âš ï¸ è­¦å‘Šç³»ç»Ÿç®—æ³•

### 1. å±é™©çº§è­¦å‘Šï¼ˆçº¢è‰²ï¼‰

**æ¡ä»¶**:
```typescript
// 1. Scoreè¿‡ä½
if (position.current_score < 60) {
  warnings.push({ type: 'danger', message: 'Score < 60' });
}

// 2. äºæŸè¿‡å¤§
const pnlPercent = calculatePnLPercent(position);
if (pnlPercent <= -40) {
  warnings.push({ type: 'danger', message: `${pnlPercent}% loss` });
}

// 3. è§¦åŠæ­¢æŸ
if (position.current_price <= position.stop_loss) {
  warnings.push({ type: 'danger', message: 'âš ï¸ HIT STOP' });
}
```

---

### 2. è­¦å‘Šçº§è­¦å‘Šï¼ˆé»„è‰²ï¼‰

**æ¡ä»¶**:
```typescript
// 1. Scoreåä½
if (position.current_score >= 60 && position.current_score < 70) {
  warnings.push({ type: 'warning', message: 'Score < 70' });
}

// 2. æ¥è¿‘åˆ°æœŸ
const daysToExp = calculateDaysToExpiration(position.expiration);
if (daysToExp <= 7) {
  warnings.push({ type: 'warning', message: `${daysToExp}d to exp!` });
}

// 3. æ¥è¿‘æ­¢æŸ
const distanceToStop = (position.current_price - position.stop_loss) / position.stop_loss;
if (distanceToStop <= 0.05) {
  warnings.push({ type: 'warning', message: '5% to stop' });
}
```

---

### 3. ä¿¡æ¯çº§æç¤ºï¼ˆè“è‰²ï¼‰

**æ¡ä»¶**:
```typescript
// Scoreè¶…è¿‡2å¤©æœªæ›´æ–°
const hoursSinceUpdate = calculateHoursSince(position.score_updated_at);
if (hoursSinceUpdate > 48) {
  warnings.push({ type: 'info', message: 'Update score' });
}
```

---

## ğŸ’° P&Lè®¡ç®—ç®—æ³•

### 3. P&Lè®¡ç®— (ä¹°æ–¹/å•è…¿æ¨¡å¼)

**æœªå®ç°P&L**:
```
Unrealized P&L = (Current Price - Average Cost) Ã— Current Quantity Ã— 100
```

**å·²å®ç°P&L**:
```
Realized P&L = Î£(Sell Price - Average Cost) Ã— Sell Quantity Ã— 100
```

### 4. å–æ–¹ä»·å·® (Credit Spread) ç‰¹æ®Šæ ¸ç®—

å¯¹äºå–æ–¹ä¿¡ç”¨ä»·å·®ï¼ˆCredit Spreadï¼‰ï¼Œç³»ç»Ÿé‡‡ç”¨â€œå¹³ä»“æˆæœ¬ï¼ˆCost to Closeï¼‰â€é€»è¾‘ï¼š

**å¹³ä»“æˆæœ¬ (Cost to Close)**:
```
Cost to Close = Short Leg Price - Long Leg Price
(å§‹ç»ˆä¿æŒä¸ºæ­£å€¼ï¼Œåæ˜ å½“å‰å¹³ä»“æ‰€éœ€æ”¯ä»˜çš„å‡€æƒåˆ©é‡‘)
```

**æœªå®ç° P&L**:
```
Unrealized P&L = (Entry Credit - Current Cost to Close) Ã— Quantity Ã— 100
```

**é€»è¾‘è§£é‡Š**:
- å¼€ä»“æ—¶è·å¾— $1.00 (Entry Credit)
- å½“å‰å¹³ä»“éœ€æ”¯ä»˜ $0.80 (Cost to Close) â†’ ç›ˆåˆ© $0.20
- å½“å‰å¹³ä»“éœ€æ”¯ä»˜ $1.20 (Cost to Close) â†’ äºæŸ $0.20

**ä»£ç å®ç° (PositionCard.tsx)**:
```typescript
if (isCreditStrategy) {
    // ä¿¡ç”¨ä»·å·®ï¼šé‡‡ç”¨ä¿å®ˆå¹³ä»“æˆæœ¬ (ShortAsk - LongBid)
    // å³ä½¿ Mid ä»·æ ¼çœ‹èµ·æ¥ç›ˆåˆ©ï¼Œåªè¦ Ask/Bid æ‚¬æ®Šï¼Œä¹Ÿä¼šä¼˜å…ˆåæ˜ æ½œåœ¨çš„å¹³ä»“äºæŸ
    const shortPrice = shortData.ask || shortData.price;
    const longPrice = longData.bid || longData.price;
    netPrice = shortPrice - longPrice;
    unrealizedPnL = (entryPrice - netPrice) * quantity * 100;
} else {
    // å€Ÿæ–¹/ä¹°æ–¹ï¼šé‡‡ç”¨å–å‡ºä»·æ ¼ (LongBid - ShortAsk)
    const longPrice = longData.bid || longData.price;
    const shortPrice = shortData.ask || shortData.price;
    netPrice = longPrice - shortPrice;
    unrealizedPnL = (netPrice - entryPrice) * currentQty * 100;
}
```

---

## ğŸ“Š ç»„åˆè¯„åˆ†ç®—æ³• (Spread Scoring)

ç³»ç»Ÿå¯¹ä»·å·®ç­–ç•¥ï¼ˆSpreadsï¼‰é‡‡ç”¨ç»¼åˆç‰¹å¾è¯„åˆ†ï¼Œç¡®ä¿ Portfolio ä¸ Strategy Recommender è¯„åˆ†ä¸€è‡´ã€‚

### 1. ä¿¡ç”¨ä»·å·®è¯„åˆ† (Credit Spread Score - CSQ+)

**æ ¸å¿ƒæƒé‡**:
- **ROI (40%)**: æƒåˆ©é‡‘ / æœ€å¤§é£é™©ã€‚25% ROI è¾¾åˆ°æ»¡åˆ†ã€‚
- **POP (40%)**: ç›ˆåˆ©æ¦‚ç‡ (1 - |Short Delta|)ã€‚
- **Distance (20%)**: è¡Œæƒä»·è·ç¦»è‚¡ä»·çš„æ·±åº¦ã€‚10% OTM è¾¾åˆ°æ»¡åˆ†ã€‚

**ä»£ç é€»è¾‘**:
```typescript
const scoreROI = Math.min(roi * 4, 100); 
const scorePOP = pop * 100;
const scoreDistance = Math.min(distance * 1000, 100); 

finalScore = Math.round(0.4 * scoreROI + 0.4 * scorePOP + 0.2 * scoreDistance);
```

### 2. å€Ÿæ–¹ä»·å·®è¯„åˆ† (Debit Spread Score - LOQ+)

**æ ¸å¿ƒæƒé‡**:
- **Lambda (40%)**: ç»„åˆæ æ†ç‡ã€‚
- **Risk/Reward (35%)**: ç›ˆäºæ¯”ã€‚1:3 R:R è¾¾åˆ°æ»¡åˆ†ã€‚**ç¡¬çº¦æŸ: RR å¿…é¡» > 1.5**ã€‚
- **Delta Bonus (25%)**: ç»„åˆ Delta å¯¹æ–¹å‘æ€§çš„å¥–åŠ±ã€‚

**ä»£ç é€»è¾‘**:
```typescript
// v2.2.1 å¼ºåŒ–è¿‡æ»¤
if (riskReward < 1.5) continue; 

const lambdaScore = Math.min((compLambda / 20) * 100, 100); 
const rrScore = Math.min((riskReward / 3) * 100, 100);      
const deltaScore = 50 + deltaBonus * 12.5;

finalScore = Math.round(0.4 * lambdaScore + 0.35 * rrScore + 0.25 * deltaScore);
```

---

## ğŸ§ª ç®—æ³•æµ‹è¯•ç¤ºä¾‹

### LOQè¯„åˆ†æµ‹è¯•

**åœºæ™¯1: ä¼˜è´¨ATM Call**
```typescript
Input:
  QQQ $630 Call, 45 DTE
  Delta: 0.45, Gamma: 0.015, Theta: -0.04
  Price: $8.50, Stock: $625
  IV Ratio: 0.92 (Contango)

Calculation:
  Lambda = 0.45 Ã— (625 / 8.50) = 33.1
  Gamma Eff = 0.015 / 8.50 = 0.00176
  Theta Burn = 0.04 / 8.50 = 0.0047
  Delta Bonus = +1.0 (åœ¨ç”œèœœåŒº)
  IV Adj = +0.5 (Contango)

Result: 82åˆ† (ä¼˜ç§€)
```

**åœºæ™¯2: å½©ç¥¨å¼OTM Call**
```typescript
Input:
  QQQ $650 Call, 30 DTE
  Delta: 0.12, Gamma: 0.008, Theta: -0.08
  Price: $1.20, Stock: $625
  IV Ratio: 1.15 (Backwardation)

Calculation:
  Lambda = 0.12 Ã— (625 / 1.20) = 62.5 (è¿‡é«˜)
  Gamma Eff = 0.008 / 1.20 = 0.0067
  Theta Burn = 0.08 / 1.20 = 0.0667 (è¿‡é«˜)
  Delta Bonus = -2.0 (å½©ç¥¨æƒ©ç½š)
  IV Adj = -3.0 (IVè¿‡è´µ)

Result: 28åˆ† (ä¸å»ºè®®)
```

---

*æ–‡æ¡£ç»´æŠ¤è€…: Trading Journal Team*
*æœ€åæ›´æ–°: 2026å¹´2æœˆ6æ—¥*
